"use strict";angular.module("dbeditClientApp",["ui.bootstrap","ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","smart-table","checklist-model","ngFileUpload"]).config(["$httpProvider",function(a){a.defaults.headers.common={},a.defaults.headers.post={},a.defaults.headers.put={},a.defaults.headers.patch={}}]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/download",{templateUrl:"views/download.html",controller:"DownloadCtrl",controllerAs:"download"}).when("/upload",{templateUrl:"views/upload.html",controller:"UploadCtrl",controllerAs:"upload"}).when("/global",{templateUrl:"views/upload_global.html",controller:"UploadGlobalCtrl",controllerAs:"upload_global"}).when("/ecus",{templateUrl:"views/upload_ecus.html",controller:"UploadEcusCtrl",controllerAs:"ecus"}).when("/edit",{templateUrl:"views/edit.html",controller:"EditCtrl",controllerAs:"edit"}).when("/vehicle/:year/:body",{templateUrl:"views/evcedit.html",controller:"EvceditCtrl",controllerAs:"evcedit"}).when("/about",{templateUrl:"views/about.html",controller:"AboutMyCtrl",controllerAs:"AboutMyCtrl"}).otherwise({redirectTo:"/"})}]).constant("config",{apiUrl:"http://localhost:8008",baseUrl:"/",enableDebug:!0}).run(["$rootScope",function(a){a.BASE_URL="http://localhost:8008",console.log("$rootScope.BASE_URL",a.BASE_URL)}]).controller("HeaderCtrl",["$scope","$location",function(a,b){a.isActive=function(a){return a===b.path()}}]),angular.module("dbeditClientApp").controller("MainCtrl",["$scope","$http","$location","$document",function(a,b,c,d){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"],a.status="",a.init=function(){a.status="",b.get(a.BASE_URL+"/init").success(function(a){c.path("/upload")}).error(function(b){a.status=b})}}]);var app=angular.module("dbeditClientApp");app.controller("EditCtrl",["$scope","$http","$location","$document","$filter","urlBuilder","$parse","$q",function(a,b,c,d,e,f,g,h){function i(b){a.showEngVehConfigs(a.selectedYb),console.log("Global DB update succeed",b),a.varver_insert_status.value="Global DB update succeed"}function j(b){console.log("Global DB update failed",b),b?a.varver_insert_status.value="Global DB update failed: "+b.code+"|"+b.message:a.varver_insert_status.value="Global DB update failed"}this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"],a.status="",a.selectedYb="all",a.ecuVarVerCollection=[],a.var_ver_selected=[],a.var_ver_selected_new_entry=[],a.varver_insert_status={label:"",value:""},a.new_entry_params=[],a.searchText="",a.ecu_buses=new Map;var k=function(){a.selectedYb="all",a.varver_insert_status.value="",a.var_ver_selected=[],a.var_ver_selected_new_entry=[]};a.checkSelectedYb=function(){(""===a.searchText||null===a.searchText||void 0===a.searchText)&&k()},a.insertEcuVarVerToGlobal=function(){a.varver_insert_status.value="",angular.forEach(a.var_ver_selected_new_entry,function(c){var d=a.new_entry_params["xmit_"+c.id],e=a.new_entry_params["gwbitpos_"+c.id],g=a.new_entry_params["bus_"+c.id];if(null===g)return a.varver_insert_status.value="Missing bus for "+c.file_name,!1;if(null===c.canbitsize)return a.varver_insert_status.value="CAN ID bit size not selected "+c.file_name,!1;var h=g.id,k=f(a.BASE_URL+"/global/"+a.selectedYb.year+"/"+a.selectedYb.body,{ecu_db_name:c.file_name,ecu_var_ver_id:c.id,new_entry:!0,hexXmitString:d,gatewayBitPos:e,busId:h,canbitsize:c.canbitsize});console.log("VarVer Insert URL",k),b.post(k).success(i).error(j)}),angular.forEach(a.var_ver_selected,function(c){var d=f(a.BASE_URL+"/global/"+a.selectedYb.year+"/"+a.selectedYb.body,{ecu_db_name:c.file_name,ecu_var_ver_id:c.id,new_entry:!1,canbitsize:c.canbitsize});console.log("VarVer Insert URL",d),b.post(d).success(i).error(j)})},a.deleteEngVehConf=function(c){b["delete"](a.BASE_URL+"/global/"+c.id).success(function(b){console.log("Eng Veh Config row deleted",b);var d=a.evcCollection.indexOf(c);a.evcCollection.splice(d,1),a.loadEcuPC()}).error(function(a){console.log("Eng Veh Config row deletion failed",a)})},a.loadYbs=function(){b.get(a.BASE_URL+"/yb").success(function(c){a.ybCollection=c,b.get(a.BASE_URL+"/global/bus").success(function(b){a.busses=b}).error(function(a){console.log("Error loading buses",a)})}).error(function(b){a.status=b,console.log("Error in get /yb",b)})},a.loadYbs(),a.isShown=function(b){return"all"===a.selectedYb?!0:a.selectedYb===b},a.loadEcuPC=function(){a.ecuVarVerCollection=[],b.get(a.BASE_URL+"/ecus").success(function(c){console.log(c),angular.forEach(c,function(c){b.get(a.BASE_URL+"/"+c+"/bus").success(function(b){console.log("buses",b),a.ecu_buses.set(c,b)}).error(function(b){console.log("Error getting"+a.BASE_URL+"/"+c+"/bus",b)}),b.get(a.BASE_URL+"/"+c+"/var_ver").success(function(b){angular.forEach(b,function(b){b.file_name=c,b.selected=!1,b.new_entry=!1,b.buses=a.ecu_buses.get(c);var d=e("filter")(a.evcCollection,{ecu_id:b.ecu_id},!0);0===d.length&&(console.log("new ecu found",d),b.new_entry=!0,a.new_entry_params.push("xmit_"+b.id),a.new_entry_params.push("gwbitpos_"+b.id),a.new_entry_params.push("bus_"+b.id)),b.has_11_bit_ids&&!b.has_29_bit_ids?b.canbitsize="11":!b.has_11_bit_ids&&b.has_29_bit_ids?b.canbitsize="29":b.canbitsize=null,a.ecuVarVerCollection.push(b)}),console.log("Var Ver Data",a.ecuVarVerCollection)}).error(function(b){console.log("Error getting"+a.BASE_URL+"/"+c+"/var_ver",b)})}),console.log("Var Ver Data",a.ecuVarVerCollection);for(var d=0;d<a.ecuVarVerCollection;d++){var f=a.ecuVarVerCollection[d],g=e("filter")(a.evcCollection,{ecu_id:f.ecu_id});null===g?(console.log("new ecu found"),f.new_entry=!0):(console.log("Existing found",f.ecu_id),f.new_entry=!1)}}).error(function(b){a.status=b,console.log("Error in get /yb",b)}),console.log("loadEcuPC completed")},a.showEngVehConfigs=function(c){a.selectedYb=c;var d=a.BASE_URL+"/global/"+c.year+"/"+c.body;a.searchText=c.year+" "+c.body,b.get(d).success(function(b){a.evcCollection=b,a.loadEcuPC()}).error(function(b){a.status=b,console.log("Error in get /global/"+c.year+"/"+c.body,b)})},a.done=function(){c.path("/download")},a.set_selected_checkbox=function(b){b.selected=!b.selected,angular.forEach(a.var_ver_selected,function(c){if(b!==c){c.selected=!1;var d=a.var_ver_selected.indexOf(c);if(d>-1)return void a.var_ver_selected.splice(d,1)}}),angular.forEach(a.var_ver_selected_new_entry,function(c){if(b!==c){c.selected=!1;var d=a.var_ver_selected_new_entry.indexOf(c);if(d>-1)return void a.var_ver_selected_new_entry.splice(d,1)}})}}]),angular.module("dbeditClientApp").controller("AboutMyCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("dbeditClientApp").controller("EvceditCtrl",["$scope","$http","$location","$document",function(a,b,c,d){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"],a.myFun=function(){}}]);var app=angular.module("dbeditClientApp");app.controller("UploadEcusCtrl",["$scope","$http","$location","$sce","Upload","$timeout",function(a,b,c,d,e,f){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"],a.upload_url=a.BASE_URL+"/ecus",a.errorMsg="",a.upload_success=!1,a.uploadFiles=function(b){a.files=b,b&&b.length&&e.upload({url:a.upload_url,data:{files:b},arrayKey:""}).then(function(b){f(function(){a.result=b.data,a.upload_success=!0})},function(b){b.status>0&&(a.errorMsg=b.status+": "+b.data)},function(b){a.progress=Math.min(100,parseInt(100*b.loaded/b.total))})},a.goToEdit=function(){c.path("/edit")},a.trustSrc=function(a){return d.trustAsResourceUrl(a)}}]),angular.module("dbeditClientApp").factory("urlBuilder",["$httpParamSerializer",function(a){function b(b,c){var d=a(c);return d.length>0&&(b+=(-1===b.indexOf("?")?"?":"&")+d),b}return b}]);var app=angular.module("dbeditClientApp");app.controller("UploadCtrl",["$scope","Upload","$timeout","$location",function(a,b,c,d){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"],a.upload_success=!1,a.uploadPic=function(d){a.init_fields(),d.upload=b.upload({url:a.BASE_URL+"/global/",data:{file:d}}),d.upload.then(function(b){c(function(){d.result=b.data,a.upload_success=!0})},function(b){b.status>0&&(a.errorMsg=b.status+": "+b.data)},function(a){d.progress=Math.min(100,parseInt(100*a.loaded/a.total))})},a.goToEcus=function(){d.path("/ecus")},a.init_fields=function(){a.upload_success=!1,a.errorMsg=""}}]),angular.module("dbeditClientApp").controller("DownloadCtrl",["$scope","$http",function(a,b){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"],a.downloadLink="",a.downloadGlobal=function(){b.get(a.BASE_URL+"/global").success(function(a){console.log("File download success",a)}).error(function(a){console.log("File download failed",a)})};var c=function(){a.downloadLink=a.BASE_URL+"/global"};c()}]),angular.module("dbeditClientApp").run(["$templateCache",function(a){a.put("views/about.html","<p>This is the about view.</p>"),a.put("views/download.html",'<div ng-controller="DownloadCtrl" class="jumbotron"> <div> <a ng-href="{{downloadLink}}">Download global.db</a> </div> </div>'),a.put("views/edit.html",'<div ng-controller="EditCtrl"> Edit View <table st-table="displayedCollection" st-safe-src="ybCollection" class="table table-striped"> <thead> <tr> <th>YB Code</th> <th>Year</th> <th>Body</th> <th>Action</th> </tr> <tr> <th colspan="4"> <!--angular.element(this).scope().setFiles(this.files)--> <!--<input st-search placeholder="global search" class="input-sm form-control" type="search" ng-model="searchText" ng-model-options="{ debounce: 500 }" ng-change="angular.element(this).scope().checkSelectedYb()"/>--> <input st-search placeholder="global search" class="input-sm form-control" type="search" ng-model="searchText" ng-change="checkSelectedYb()"> </th> </tr> </thead> <tbody> <tr ng-repeat="yb in displayedCollection" ng-show="isShown(yb)"> <td>{{yb.yb_code}}</td> <td>{{yb.year}}</td> <td>{{yb.body}}</td> <!--      		<td><a ng-href="http://localhost:8080/vehicle/{{yb.year}}/{{yb.body}}" ng-click="showEngVehConfigs({{yb.year}},{{yb.body}})">Select</a></td>--> <td> <button type="button" class="btn btn-sm btn-primary" ng-click="showEngVehConfigs(yb)">Select</button> </td> </tr> </tbody> </table> <form name="varVerForm" ng-submit="insertEcuVarVerToGlobal()"> <div class="panel panel-success" ng-show="!isShown(yb)"> <div class="panel-heading"> <h3 class="panel-title">ECU Variant Info</h3> </div> <table st-table="displayedEcuVarVerCollection" st-safe-src="ecuVarVerCollection" class="table table-striped" ng-show="!isShown(yb)"> <!--	<table st-table="ybCollection" class="table table-striped">--> <thead> <tr class="danger"> <td colspan="6"> <h5>Select and enter the new ecu variants before deleting the old ones from the vehicle config table below.</h5></td> </tr> <tr> <th>File Name</th> <th>Var Ver Id</th> <th>Update Existing ECU</th> <th>New ECU Entry</th> <th>Extra</th> <th>11/29 bit</th> <!--\r\n						<th>protocol_id</th>\r\n						<th>protocol_sdd_id</th>\r\n						<th>sdd_version</th>\r\n						<th>transport</th>\r\n						<th>use_29_bit_can_id</th>\r\n						<th>use_frame_padding</th>\r\n						<th>use_extended_address</th>\r\n						--> </tr> <tr></tr> </thead> <tbody> <tr ng-repeat="ecu_var_ver in displayedEcuVarVerCollection"> <td>{{ecu_var_ver.file_name}}</td> <td>{{ecu_var_ver.id}}</td> <td> <!--							<input type="checkbox" data-checklist-model="var_ver_selected" data-checklist-value="ecu_var_ver" ng-disabled="ecu_var_ver.new_entry" ng-click="ecu_var_ver.selected = !ecu_var_ver.selected">--> <input type="checkbox" data-checklist-model="var_ver_selected" data-checklist-value="ecu_var_ver" ng-disabled="ecu_var_ver.new_entry" ng-click="set_selected_checkbox(ecu_var_ver)"> <!--							<input type="radio" name="check_box_name" ng-model="var_ver_selected" value="{{ecu_var_ver.id}}" ng-disabled="ecu_var_ver.new_entry" ng-click="ecu_var_ver.selected = !ecu_var_ver.selected" required>--> </td> <td> <input type="checkbox" data-checklist-model="var_ver_selected_new_entry" data-checklist-value="ecu_var_ver" ng-show="ecu_var_ver.new_entry" ng-click="set_selected_checkbox(ecu_var_ver)"> </td> <td> <input type="text" name="xmit_{{ecu_var_ver.id}}" ng-model="new_entry_params[\'xmit_\'+ecu_var_ver.id]" ng-disabled="!ecu_var_ver.selected" ng-show="ecu_var_ver.new_entry" placeholder="XMIT"> <input type="text" name="gwbitpos_{{ecu_var_ver.id}}" ng-model="new_entry_params[\'gwbitpos_\'+ecu_var_ver.id]" ng-disabled="!ecu_var_ver.selected" ng-show="ecu_var_ver.new_entry" placeholder="Gateway Bit Pos"> <!--							<select name="bus_{{ecu_var_ver.id}}" ng-model="new_entry_params[\'bus_\'+ecu_var_ver.id]" ng-options="bus.name for bus in busses" ng-disabled="!ecu_var_ver.new_entry" ng-show="ecu_var_ver.new_entry"></select>--> <select name="bus_{{ecu_var_ver.id}}" ng-model="new_entry_params[\'bus_\'+ecu_var_ver.id]" ng-options="(bus.id + \' | \' + bus.name + \' | \' + bus.interface_pins) for bus in ecu_var_ver.buses" ng-disabled="!ecu_var_ver.selected" ng-show="ecu_var_ver.new_entry"></select> </td> <td> <label> <!--<input type="radio" name="{{ecu_var_ver.id}}" ng-model="ecu_var_ver.canbitsize" value="11" ng-disabled="!(ecu_var_ver.has_11_bit_ids && ecu_var_ver.has_29_bit_ids)" required="false">11 bit</label>--> <input type="radio" name="{{ecu_var_ver.id}}" ng-model="ecu_var_ver.canbitsize" value="11" ng-disabled="!(ecu_var_ver.selected)" required>11 bit</label> <label> <!--<input type="radio" name="{{ecu_var_ver.id}}" ng-model="ecu_var_ver.canbitsize" value="29" ng-disabled="!(ecu_var_ver.has_11_bit_ids && ecu_var_ver.has_29_bit_ids)" required="false">29 bit</label>--> <input type="radio" name="{{ecu_var_ver.id}}" ng-model="ecu_var_ver.canbitsize" value="29" ng-disabled="!(ecu_var_ver.selected)" required>29 bit</label> </td> </tr> <tr> <td colspan="1"> <!--button class="btn btn-sm btn-primary" ng-click="insertEcuVarVerToGlobal()" ng-show="!isShown(yb)">Add to Global</button--> <button class="btn btn-sm btn-primary" type="submit">Add to Global</button> </td> <td colspan="5"> <label name="varver_insert_status">{{varver_insert_status.value}}</label> </td> </tr> </tbody> </table> </div> </form> <div class="panel panel-success" ng-show="!isShown(yb)"> <div class="panel-heading"> <h3 class="panel-title">Vehicle Configuration</h3> </div> <div class="panel-body"> <div class="table-responsive"> <!--	<table st-table="displayedEvcCollection" st-safe-src="evcCollection" class="table table-striped" ng-show="!isShown(yb)" >--> <table st-table="displayedEvcCollection" st-safe-src="evcCollection" ng-show="!isShown(yb)" class="table table-bordered table-hover specialCollapse"> <!--	<table st-table="ybCollection" class="table table-striped">--> <thead> <tr> <!--		      <th>id</th>--> <th>Action</th> <th>year</th> <th>body</th> <th>var_ver_id</th> <th>ecu_acronym</th> <th>is_gateway</th> <th>xmit_str</th> <th>disable_gateway_command</th> <th>gateway_bit_position</th> <th>bus_id</th> <th>diag_bus_id</th> <th>request_id</th> <th>response_id</th> <!--			<th>broadcast_id</th>--> <!--			<th>protocol_config_id</th>--> <!--			<th>kline_protocol_config_id</th>--> <!--			<th>ecu_address</th>--> <th>ident_type</th> <th>is_engine</th> <th>is_vin_master</th> <!--			<th>architecture_id</th>--> <!--			<th>yb_version</th>--> <th>ecu_config</th> <!--			<th>name_string_id</th>--> <th>db_name</th> <!--			<th>built_state</th>--> <th>odometer_master_data</th> <!--			<th>proxi_type</th>--> <!--			<th>proxi_config_set_id</th>--> <th>is_sgw</th> </tr> <tr> <!--			<th colspan="3"><input st-search placeholder="global search" class="input-sm form-control" type="search"/></th>--> </tr> </thead> <tbody> <tr ng-repeat="evc in displayedEvcCollection"> <!--      		<td>{{evc.id}}</td>--> <td> <button type="button" class="btn btn-warning glyphicon glyphicon-trash" ng-click="deleteEngVehConf(evc)">Delete</button> </td> <td>{{evc.year}}</td> <td>{{evc.body}}</td> <td>{{evc.var_ver_id}}</td> <td>{{evc.ecu_acronym}}</td> <td>{{evc.is_gateway}}</td> <td>{{evc.xmit_str}}</td> <td>{{evc.disable_gateway_command}}</td> <td>{{evc.gateway_bit_position}}</td> <td>{{evc.bus_id}}</td> <td>{{evc.diag_bus_id}}</td> <td>{{evc.request_id}}</td> <td>{{evc.response_id}}</td> <!--			<td>{{evc.broadcast_id}}</td>--> <!--			<td>{{evc.protocol_config_id}}</td>--> <!--			<td>{{evc.kline_protocol_config_id}}</td>--> <!--			<td>{{evc.ecu_address}}</td>--> <td>{{evc.ident_type}}</td> <td>{{evc.is_engine}}</td> <td>{{evc.is_vin_master}}</td> <!--			<td>{{evc.architecture_id}}</td>--> <!--			<td>{{evc.yb_version}}</td>--> <td>{{evc.ecu_config}}</td> <!--			<td>{{evc.name_string_id}}</td>--> <td>{{evc.db_name}}</td> <!--			<td>{{evc.built_state}}</td>--> <td>{{evc.odometer_master_data}}</td> <!--			<td>{{evc.proxi_type}}</td>--> <!--			<td>{{evc.proxi_config_set_id}}</td>--> <td>{{evc.is_sgw}}</td> </tr> </tbody> </table> </div> </div> </div> <div name="ticker">{{status}}</div> <div class="jumbotron" ng-show="!isShown(yb)"> <div class="text-center"> <button class="btn btn-sm btn-success" ng-click="done()">Done</button> </div> </div> </div>'),a.put("views/evcedit.html","<p>This is the evcEdit view.</p>"),a.put("views/main.html",'<div ng-controller="MainCtrl"> <div class="row marketing"> <h4>Silent Update DB Editor</h4> <p> On next screen upload the global db and the ECU dbs that has varver ids that need to be inserted to the global db. </p> <p style="color: #F00"> Do not use menus (Upload or Edit) on the top of the page if you have a new global db. Click on "Next" and continue the screens. </p> </div> <div class="jumbotron" ng-show="!isShown(yb)"> <div class="text-center"> <button class="btn btn-sm btn-success" ng-click="init()">Next</button> </div> <label>{{status}}</label> </div> </div>'),a.put("views/upload.html",'<div ng-controller="UploadCtrl" nv-file-drop="" uploader="uploader" class="jumbotron"> <!-- Example from: http://jsfiddle.net/danialfarid/maqbzv15/1118/ --> <form name="glDbForm"> <fieldset> <legend>Upload on Global DB</legend> <!--\n			Username:\n			<input type="text" name="userName" ng-model="username" size="31" required>\n			<i ng-show="myForm.userName.$error.required">*required</i>\n--> <br>Global DB: <input type="file" ngf-select ng-model="picFile" name="file" ngf-max-size="2MB" required ngf-model-invalid="errorFile" accept=".db"> <i ng-show="myForm.file.$error.required">*required</i> <br> <i ng-show="myForm.file.$error.maxSize">File too large {{errorFile.size / 1000000|number:1}}MB: max 2M</i> <button ng-disabled="!glDbForm.$valid" ng-click="uploadPic(picFile)">Submit</button> <span class="progress" ng-show="picFile.progress >= 0"> <div style="width:{{picFile.progress}}%" ng-bind="picFile.progress + \'%\'"></div> </span> <span ng-show="picFile.result">Upload Successful</span> <span class="err" ng-show="errorMsg">{{errorMsg}}</span> </fieldset> <br> </form> <button button class="btn btn-sm btn-success" ng-click="goToEcus()" ng-show="upload_success">Next</button> </div>'),a.put("views/upload_ecus.html",'<div ng-controller="UploadEcusCtrl" nv-file-drop=""> <div class="jumbotron"> <h4>Upload ECU DB file</h4> <button ngf-select="uploadFiles($files)" multiple accept=".db">Select Files</button> <br> <br>Files: <ul> <li ng-repeat="f in files" style="font:smaller"> {{f.name}} </li> </ul> <span class="progress" ng-show="progress >= 0"> <div style="width:{{progress}}%" ng-bind="progress + \'%\'"></div> </span> {{errorMsg}} <button button class="btn btn-sm btn-success" ng-click="goToEdit()" ng-show="upload_success">Next</button> </div> </div>')}]);